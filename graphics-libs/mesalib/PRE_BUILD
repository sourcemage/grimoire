default_pre_build                                            &&
cd ${SOURCE_DIRECTORY}                                       &&
patch -p1 < $SPELL_DIRECTORY/gl_select-scm.patch             &&
patch -p0 < ${SPELL_DIRECTORY}/Makefile-fix-sed-expression.patch &&
cd ${SOURCE_DIRECTORY}/configs                               &&
sedit "s:/usr/local:/usr:g" default                          &&

if grep -q dri <<< "$MESALIB_BUILD"
then
sedit "/^DRI_DIRS/ { N; s/.*/DRI_DIRS = $MESALIB_DRIVERS/ }" $SOURCE_DIRECTORY/configs/linux-dri
sedit "/^DRI_DIRS/ { N; s/.*/DRI_DIRS = $MESALIB_DRIVERS/ }" $SOURCE_DIRECTORY/configs/linux-dri-x86-64
fi                                                           &&

sedit "s:MKDEP = /usr/X11R6:MKDEP = /usr/:g" linux-dri       &&
sedit "s:MKDEP = /usr/X11R6:MKDEP = /usr/:g" linux-indirect  &&
sedit "s:/X11R6::g" linux-dri                                &&
sedit "s:/X11R6::g" default                                  &&
sedit "s:/X11R6::g" linux-indirect                           &&

# x86-64 libs go into normal lib/
for i in linux*x86-64
do
  sedit "s/LIB_DIR = lib64//" "$i"
done &&
cd ${SOURCE_DIRECTORY}/docs                                  &&
sedit "s:/X11R6::g" install.html                             &&
cd ${SOURCE_DIRECTORY}/src/mesa/drivers/dri                  &&
sedit "s:/X11R6::g" Makefile.template                        &&
cd ${SOURCE_DIRECTORY}/src/glw                               &&
sedit "s:/X11R6::g" Makefile                                 &&

if [[ $MESALIB_VER == "git" ]]; then
  cd "$SOURCE_DIRECTORY"                                     &&
  patch -p0 < "${SCRIPT_DIRECTORY}/autogen.patch"            &&
  ./autogen.sh
  cd bin
fi
