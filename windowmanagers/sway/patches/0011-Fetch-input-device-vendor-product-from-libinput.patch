From dc5dd92061760668ae752007970f2be2d838be5f Mon Sep 17 00:00:00 2001
From: Simon Ser <contact@emersion.fr>
Date: Thu, 7 Mar 2024 12:16:11 +0100
Subject: [PATCH 11/15] Fetch input device vendor/product from libinput

References: https://gitlab.freedesktop.org/wlroots/wlroots/-/merge_requests/4582
Origin: Upstream
Upstream-Status: Backported [commit f2a0e81b2438853e12a2b8fe9bddde154852d85d]
Signed-off-by: Ismael Luceno <ismael@sourcemage.org>
---
 sway/input/input-manager.c | 11 +++++++++--
 sway/ipc-json.c            |  8 ++++----
 2 files changed, 13 insertions(+), 6 deletions(-)

diff --git a/sway/input/input-manager.c b/sway/input/input-manager.c
index bac36a168857..c6a61c89c3b8 100644
--- a/sway/input/input-manager.c
+++ b/sway/input/input-manager.c
@@ -66,8 +66,15 @@ struct sway_seat *input_manager_sway_seat_from_wlr_seat(struct wlr_seat *wlr_sea
 }
 
 char *input_device_get_identifier(struct wlr_input_device *device) {
-	int vendor = device->vendor;
-	int product = device->product;
+	int vendor = 0, product = 0;
+#if WLR_HAS_LIBINPUT_BACKEND
+	if (wlr_input_device_is_libinput(device)) {
+		struct libinput_device *libinput_dev = wlr_libinput_get_device_handle(device);
+		vendor = libinput_device_get_id_vendor(libinput_dev);
+		product = libinput_device_get_id_product(libinput_dev);
+	}
+#endif
+
 	char *name = strdup(device->name ? device->name : "");
 	strip_whitespace(name);
 
diff --git a/sway/ipc-json.c b/sway/ipc-json.c
index 58356d4ea7cc..484b8118e5c0 100644
--- a/sway/ipc-json.c
+++ b/sway/ipc-json.c
@@ -1086,10 +1086,6 @@ json_object *ipc_json_describe_input(struct sway_input_device *device) {
 		json_object_new_string(device->identifier));
 	json_object_object_add(object, "name",
 		json_object_new_string(device->wlr_device->name));
-	json_object_object_add(object, "vendor",
-		json_object_new_int(device->wlr_device->vendor));
-	json_object_object_add(object, "product",
-		json_object_new_int(device->wlr_device->product));
 	json_object_object_add(object, "type",
 		json_object_new_string(
 			input_device_get_type(device)));
@@ -1143,6 +1139,10 @@ json_object *ipc_json_describe_input(struct sway_input_device *device) {
 		libinput_dev = wlr_libinput_get_device_handle(device->wlr_device);
 		json_object_object_add(object, "libinput",
 				describe_libinput_device(libinput_dev));
+		json_object_object_add(object, "vendor",
+			json_object_new_int(libinput_device_get_id_vendor(libinput_dev)));
+		json_object_object_add(object, "product",
+			json_object_new_int(libinput_device_get_id_product(libinput_dev)));
 	}
 #endif
 
-- 
2.46.0

