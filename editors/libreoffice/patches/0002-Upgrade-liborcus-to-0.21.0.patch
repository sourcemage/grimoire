From e7ec193c7bfb3b51e3de551b26308dbcd67d8ac9 Mon Sep 17 00:00:00 2001
From: Kohei Yoshida <kohei.yoshida@collabora.com>
Date: Mon, 15 Sep 2025 22:28:20 -0400
Subject: [PATCH 2/2] Upgrade liborcus to 0.21.0

Change-Id: I39bd6d94d03ba7f7c4ce6a2bdd1fb12c1078b42e
Reviewed-on: https://gerrit.libreoffice.org/c/core/+/191011
Tested-by: Jenkins
Reviewed-by: Kohei Yoshida <kohei@libreoffice.org>
Upstream-Status: Backport
[ismael@sourcemage.org: Added autoconf output]
Signed-off-by: Ismael Luceno <ismael@sourcemage.org>
---
 RepositoryExternal.mk                          | 4 ++--
 configure                                      | 18 +++++++++---------
 configure.ac                                   | 2 +-
 download.lst                                   | 4 ++--
 external/liborcus/ExternalPackage_liborcus.mk  | 8 ++++----
 external/liborcus/ExternalProject_liborcus.mk  | 4 ++--
 external/liborcus/windows-constants-hack.patch | 4 ++--
 7 files changed, 22 insertions(+), 22 deletions(-)

diff --git a/RepositoryExternal.mk b/RepositoryExternal.mk
index 8820a1ed34bd..37212b26fcee 100644
--- a/RepositoryExternal.mk
+++ b/RepositoryExternal.mk
@@ -3382,7 +3382,7 @@ $(call gb_LinkTarget_set_include,$(1),\
 )
 
 $(call gb_LinkTarget_add_libs,$(1),\
-       -L$(gb_UnpackedTarball_workdir)/liborcus/src/liborcus/.libs -lorcus-0.20 \
+       -L$(gb_UnpackedTarball_workdir)/liborcus/src/liborcus/.libs -lorcus-0.21 \
 )
 
 $(if $(SYSTEM_BOOST), \
@@ -3401,7 +3401,7 @@ $(call gb_LinkTarget_set_include,$(1),\
 )
 
 $(call gb_LinkTarget_add_libs,$(1),\
-	-L$(gb_UnpackedTarball_workdir)/liborcus/src/parser/.libs -lorcus-parser-0.20 \
+	-L$(gb_UnpackedTarball_workdir)/liborcus/src/parser/.libs -lorcus-parser-0.21 \
 )
 
 endef
diff --git a/configure.ac b/configure.ac
index a95455dc4468..fa3336d47eef 100644
--- a/configure.ac
+++ b/configure.ac
@@ -11456,7 +11456,7 @@ fi
 dnl ===================================================================
 dnl Orcus
 dnl ===================================================================
-libo_CHECK_SYSTEM_MODULE([orcus],[ORCUS],[liborcus-0.20 >= 0.20.0])
+libo_CHECK_SYSTEM_MODULE([orcus],[ORCUS],[liborcus-0.21 >= 0.21.0])
 
 dnl FIXME by renaming SYSTEM_LIBORCUS to SYSTEM_ORCUS in the build system world
 SYSTEM_LIBORCUS=$SYSTEM_ORCUS
diff --git a/download.lst b/download.lst
index c558cfaa6795..1a83b81d9f68 100644
--- a/download.lst
+++ b/download.lst
@@ -554,8 +554,8 @@ OPENSSL_TARBALL := openssl-3.0.18.tar.gz
 # three static lines
 # so that git cherry-pick
 # will not run into conflicts
-ORCUS_SHA256SUM := ec27f30e8445a2a3f307f7e829fc446fd48193150b7f8f23bb5bfb25ec6e4e27
-ORCUS_TARBALL := liborcus-0.20.1.tar.xz
+ORCUS_SHA256SUM := 1c6e473d6b8a63d61d0e6874a1762d6f0e0e78338d763e48ac93126ecde19b37
+ORCUS_TARBALL := liborcus-0.21.0.tar.xz
 # three static lines
 # so that git cherry-pick
 # will not run into conflicts
diff --git a/external/liborcus/ExternalPackage_liborcus.mk b/external/liborcus/ExternalPackage_liborcus.mk
index b9be5fcac405..e4682fe1464b 100644
--- a/external/liborcus/ExternalPackage_liborcus.mk
+++ b/external/liborcus/ExternalPackage_liborcus.mk
@@ -12,11 +12,11 @@ $(eval $(call gb_ExternalPackage_ExternalPackage,liborcus,liborcus))
 $(eval $(call gb_ExternalPackage_use_external_project,liborcus,liborcus))
 
 ifeq ($(OS),MACOSX)
-$(eval $(call gb_ExternalPackage_add_file,liborcus,$(LIBO_LIB_FOLDER)/liborcus-0.20.0.dylib,src/liborcus/.libs/liborcus-0.20.0.dylib))
-$(eval $(call gb_ExternalPackage_add_file,liborcus,$(LIBO_LIB_FOLDER)/liborcus-parser-0.20.0.dylib,src/parser/.libs/liborcus-parser-0.20.0.dylib))
+$(eval $(call gb_ExternalPackage_add_file,liborcus,$(LIBO_LIB_FOLDER)/liborcus-0.21.0.dylib,src/liborcus/.libs/liborcus-0.21.0.dylib))
+$(eval $(call gb_ExternalPackage_add_file,liborcus,$(LIBO_LIB_FOLDER)/liborcus-parser-0.21.0.dylib,src/parser/.libs/liborcus-parser-0.21.0.dylib))
 else ifeq ($(DISABLE_DYNLOADING),)
-$(eval $(call gb_ExternalPackage_add_file,liborcus,$(LIBO_LIB_FOLDER)/liborcus-0.20.so.0,src/liborcus/.libs/liborcus-0.20.so.0.0.0))
-$(eval $(call gb_ExternalPackage_add_file,liborcus,$(LIBO_LIB_FOLDER)/liborcus-parser-0.20.so.0,src/parser/.libs/liborcus-parser-0.20.so.0.0.0))
+$(eval $(call gb_ExternalPackage_add_file,liborcus,$(LIBO_LIB_FOLDER)/liborcus-0.21.so.0,src/liborcus/.libs/liborcus-0.21.so.0.0.0))
+$(eval $(call gb_ExternalPackage_add_file,liborcus,$(LIBO_LIB_FOLDER)/liborcus-parser-0.21.so.0,src/parser/.libs/liborcus-parser-0.21.so.0.0.0))
 endif
 
 # vim: set noet sw=4 ts=4:
diff --git a/external/liborcus/ExternalProject_liborcus.mk b/external/liborcus/ExternalProject_liborcus.mk
index d2e05226e4f1..3787ef4688dc 100644
--- a/external/liborcus/ExternalProject_liborcus.mk
+++ b/external/liborcus/ExternalProject_liborcus.mk
@@ -114,8 +114,8 @@ $(call gb_ExternalProject_get_state_target,liborcus,build) :
 		   $(MAKE) \
 		$(if $(filter MACOSX,$(OS)),\
 			&& $(PERL) $(SRCDIR)/solenv/bin/macosx-change-install-names.pl shl OOO \
-				$(EXTERNAL_WORKDIR)/src/liborcus/.libs/liborcus-0.20.0.dylib \
-				$(EXTERNAL_WORKDIR)/src/parser/.libs/liborcus-parser-0.20.0.dylib \
+				$(EXTERNAL_WORKDIR)/src/liborcus/.libs/liborcus-0.21.0.dylib \
+				$(EXTERNAL_WORKDIR)/src/parser/.libs/liborcus-parser-0.21.0.dylib \
 		) \
 	)
 	$(call gb_Trace_EndRange,liborcus,EXTERNAL)
diff --git a/external/liborcus/windows-constants-hack.patch b/external/liborcus/windows-constants-hack.patch
index 28cf0997a168..3f09633638d4 100644
--- a/external/liborcus/windows-constants-hack.patch
+++ b/external/liborcus/windows-constants-hack.patch
@@ -8,8 +8,8 @@ index ae571f5..539ce18 100644
 
 -#include "constants.inl"
 +#define ORCUS_MAJOR_VERSION 0
-+#define ORCUS_MINOR_VERSION 19
-+#define ORCUS_MICRO_VERSION 2
++#define ORCUS_MINOR_VERSION 21
++#define ORCUS_MICRO_VERSION 0
 
  namespace orcus {
 
diff --git a/usr/src/libreoffice-25.8.4.2/configure b/configure
index 8bea2f488629..f88270b4b385 100755
--- a/usr/src/libreoffice-25.8.4.2/configure
+++ b/configure
@@ -37667,12 +37667,12 @@ if test -n "$ORCUS_CFLAGS"; then
     pkg_cv_ORCUS_CFLAGS="$ORCUS_CFLAGS"
  elif test -n "$PKG_CONFIG"; then
     if test -n "$PKG_CONFIG" && \
-    { { printf "%s\n" "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"liborcus-0.20 >= 0.20.0\""; } >&5
-  ($PKG_CONFIG --exists --print-errors "liborcus-0.20 >= 0.20.0") 2>&5
+    { { printf "%s\n" "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"liborcus-0.21 >= 0.21.0\""; } >&5
+  ($PKG_CONFIG --exists --print-errors "liborcus-0.21 >= 0.21.0") 2>&5
   ac_status=$?
   printf "%s\n" "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
   test $ac_status = 0; }; then
-  pkg_cv_ORCUS_CFLAGS=`$PKG_CONFIG --cflags "liborcus-0.20 >= 0.20.0" 2>/dev/null`
+  pkg_cv_ORCUS_CFLAGS=`$PKG_CONFIG --cflags "liborcus-0.21 >= 0.21.0" 2>/dev/null`
 		      test "x$?" != "x0" && pkg_failed=yes
 else
   pkg_failed=yes
@@ -37684,12 +37684,12 @@ if test -n "$ORCUS_LIBS"; then
     pkg_cv_ORCUS_LIBS="$ORCUS_LIBS"
  elif test -n "$PKG_CONFIG"; then
     if test -n "$PKG_CONFIG" && \
-    { { printf "%s\n" "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"liborcus-0.20 >= 0.20.0\""; } >&5
-  ($PKG_CONFIG --exists --print-errors "liborcus-0.20 >= 0.20.0") 2>&5
+    { { printf "%s\n" "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"liborcus-0.21 >= 0.21.0\""; } >&5
+  ($PKG_CONFIG --exists --print-errors "liborcus-0.21 >= 0.21.0") 2>&5
   ac_status=$?
   printf "%s\n" "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
   test $ac_status = 0; }; then
-  pkg_cv_ORCUS_LIBS=`$PKG_CONFIG --libs "liborcus-0.20 >= 0.20.0" 2>/dev/null`
+  pkg_cv_ORCUS_LIBS=`$PKG_CONFIG --libs "liborcus-0.21 >= 0.21.0" 2>/dev/null`
 		      test "x$?" != "x0" && pkg_failed=yes
 else
   pkg_failed=yes
@@ -37710,14 +37710,14 @@ else
         _pkg_short_errors_supported=no
 fi
         if test $_pkg_short_errors_supported = yes; then
-	        ORCUS_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors --cflags --libs "liborcus-0.20 >= 0.20.0" 2>&1`
+	        ORCUS_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors --cflags --libs "liborcus-0.21 >= 0.21.0" 2>&1`
         else
-	        ORCUS_PKG_ERRORS=`$PKG_CONFIG --print-errors --cflags --libs "liborcus-0.20 >= 0.20.0" 2>&1`
+	        ORCUS_PKG_ERRORS=`$PKG_CONFIG --print-errors --cflags --libs "liborcus-0.21 >= 0.21.0" 2>&1`
         fi
 	# Put the nasty error message in config.log where it belongs
 	echo "$ORCUS_PKG_ERRORS" >&5
 
-	as_fn_error $? "Package requirements (liborcus-0.20 >= 0.20.0) were not met:
+	as_fn_error $? "Package requirements (liborcus-0.21 >= 0.21.0) were not met:
 
 $ORCUS_PKG_ERRORS
 
